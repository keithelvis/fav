<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>BBC & WSJ - 24å°æ—¶å†…æ–°é—»åˆ—è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji';}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;}
    h1{font-size:24px;margin:0 0 12px;}
    .sub{color:var(--muted);font-size:14px;margin-bottom:20px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 980px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    .card h2{margin:0 0 8px;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{background:#f3f4f6}
    .count{margin-left:auto;color:var(--muted);font-size:12px}
    .item{padding:10px 0;border-top:1px dashed var(--border)}
    .item:first-child{border-top:0}
    .item a{color:#0f62fe;text-decoration:none}
    .item a:hover{text-decoration:underline}
    .time{color:var(--muted);font-size:12px;margin-top:4px}
    .status{font-size:13px;color:var(--muted);margin:8px 0}
    .error{color:#dc2626}
    .footer{margin-top:20px;color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BBC & åå°”è¡—æ—¥æŠ¥ï¼šæœ€è¿‘ 24 å°æ—¶æ–°é—»</h1>
    <div class="sub">
      å®æ—¶ä» RSS è·å–ï¼ŒæŒ‰å‘å¸ƒæ—¶é—´å€’åºï¼›å„åª’ä½“å•ç‹¬å±•ç¤ºã€‚
      <span class="badge" id="updatedAt">æœªåˆ·æ–°</span>
    </div>

    <div class="grid">
      <!-- BBC æ¨¡å— -->
      <section class="card" id="bbc">
        <h2>BBC ä¸­æ–‡ï¼ˆç¹ï¼‰</h2>
        <div class="controls">
          <button data-action="refresh" data-feed="bbc">åˆ·æ–°</button>
          <span class="count" id="bbc-count">â€”</span>
        </div>
        <div class="status" id="bbc-status">åŠ è½½ä¸­â€¦</div>
        <div id="bbc-list"></div>
      </section>

      <!-- WSJ æ¨¡å— -->
      <section class="card" id="wsj">
        <h2>åå°”è¡—æ—¥æŠ¥ï¼ˆä¸­æ–‡ç½‘ï¼‰</h2>
        <div class="controls">
          <button data-action="refresh" data-feed="wsj">åˆ·æ–°</button>
          <span class="count" id="wsj-count">â€”</span>
        </div>
        <div class="status" id="wsj-status">åŠ è½½ä¸­â€¦</div>
        <div id="wsj-list"></div>
      </section>
    </div>

    <div class="footer">
      æ•°æ®æºï¼š
      <a href="https://feeds.bbci.co.uk/zhongwen/trad/rss.xml" target="_blank" rel="noreferrer">BBC RSS</a> ãƒ»
      <a href="https://cn.wsj.com/zh-hans/rss" target="_blank" rel="noreferrer">WSJ RSS</a>
      ï½œä»…åšå®¢æˆ·ç«¯è¯»å–ï¼Œä¸å­˜å‚¨ä»»ä½•æ•°æ®ã€‚
    </div>
  </div>

  <script>
    // ===== é…ç½®åŒºåŸŸ =====
    const FEEDS = {
      bbc: "https://feeds.bbci.co.uk/zhongwen/trad/rss.xml",
      wsj: "https://cn.wsj.com/zh-hans/rss",
    };
    // 24 å°æ—¶çª—å£
    const HOURS_WINDOW = 24;

    // å¤šçº§å›é€€çš„ CORS è·å–ï¼ˆç›´è¿ â†’ AllOrigins â†’ isomorphic-git CORSï¼‰
    async function fetchWithCors(url) {
      // 1) ç›´è¿
      try {
        const r = await fetch(url, { headers: { "Accept": "application/rss+xml,application/xml;text/xml;q=0.9,*/*;q=0.8" } });
        if (r.ok) return r.text();
      } catch(e) {}

      // 2) AllOriginsï¼ˆåŸæ ·è¿”å›ï¼‰
      try {
        const r2 = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
        if (r2.ok) return r2.text();
      } catch(e) {}

      // 3) isomorphic-git CORS
      const corsBridge = "https://cors.isomorphic-git.org/";
      try {
        const r3 = await fetch(corsBridge + url);
        if (r3.ok) return r3.text();
      } catch(e) {}

      throw new Error("æ— æ³•è·å– RSSï¼ˆå¯èƒ½è¢« CORS é™åˆ¶æˆ–æºç«™æš‚ä¸å¯è¾¾ï¼‰");
    }

    // è§£æ RSS -> [{title, link, pubDate: Date}]
    function parseRss(xmlText) {
      const doc = new DOMParser().parseFromString(xmlText, "application/xml");
      // é”™è¯¯å¤„ç†
      const parserErr = doc.querySelector("parsererror");
      if (parserErr) throw new Error("RSS è§£æå¤±è´¥");

      const items = Array.from(doc.querySelectorAll("item"));
      // Atom å…¼å®¹ï¼ˆå¦‚é‡åˆ° <entry>ï¼‰
      const entries = items.length ? items : Array.from(doc.querySelectorAll("entry"));

      return entries.map(el => {
        // å…¼å®¹ rss/atom çš„å­—æ®µå‘½å
        const title = (el.querySelector("title")?.textContent || "").trim();
        let link = (el.querySelector("link")?.getAttribute?.("href") || el.querySelector("link")?.textContent || "").trim();

        // pubDate / updated / published
        const pubRaw =
          el.querySelector("pubDate")?.textContent?.trim() ||
          el.querySelector("updated")?.textContent?.trim() ||
          el.querySelector("published")?.textContent?.trim() ||
          "";

        let pubDate = null;
        if (pubRaw) {
          const t = new Date(pubRaw);
          if (!isNaN(t.valueOf())) pubDate = t;
        }
        return { title, link, pubDate };
      });
    }

    function withinLastHours(date, hours) {
      if (!date) return false;
      const now = Date.now();
      return (now - date.getTime()) <= hours * 3600 * 1000;
    }

    function renderList(rootId, statusId, countId, list) {
      const root = document.getElementById(rootId);
      const status = document.getElementById(statusId);
      const countEl = document.getElementById(countId);

      const frag = document.createDocumentFragment();
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        const title = item.title || "(æ— æ ‡é¢˜)";
        const href = item.link || "#";
        const timeStr = item.pubDate ? item.pubDate.toLocaleString() : "æœªçŸ¥æ—¶é—´";
        div.innerHTML = `
          <a href="${href}" target="_blank" rel="noreferrer">${escapeHtml(title)}</a>
          <div class="time">ğŸ•’ ${timeStr}</div>
        `;
        frag.appendChild(div);
      });

      // æ¸…ç©ºå¹¶æ’å…¥
      const listBox = document.getElementById(rootId + "-list") || root.querySelector("div[id$='-list']");
      listBox.innerHTML = "";
      listBox.appendChild(frag);

      status.textContent = list.length ? "" : "æœ€è¿‘ 24 å°æ—¶å†…æš‚æ— æ›´æ–°";
      countEl.textContent = `${list.length} ç¯‡`;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function loadFeed(key) {
      const url = FEEDS[key];
      const statusId = `${key}-status`;
      const listRootId = key; // section id
      const countId = `${key}-count`;
      const statusEl = document.getElementById(statusId);
      statusEl.classList.remove("error");
      statusEl.textContent = "åŠ è½½ä¸­â€¦";

      try {
        const xml = await fetchWithCors(url);
        const all = parseRss(xml)
          .filter(x => x.title || x.link)         // åŸºæœ¬å¯ç”¨
          .filter(x => withinLastHours(x.pubDate, HOURS_WINDOW))
          .sort((a,b) => (b.pubDate?.getTime() || 0) - (a.pubDate?.getTime() || 0));

        renderList(listRootId, statusId, countId, all);
        return true;
      } catch (err) {
        statusEl.textContent = "åŠ è½½å¤±è´¥ï¼š" + (err.message || err);
        statusEl.classList.add("error");
        renderList(listRootId, statusId, countId, []); // æ¸…ç©º
        return false;
      }
    }

    async function refreshAll() {
      const ok1 = await loadFeed("bbc");
      const ok2 = await loadFeed("wsj");
      document.getElementById("updatedAt").textContent =
        "å·²åˆ·æ–°ï¼š" + new Date().toLocaleString() + (ok1 && ok2 ? "" : "ï¼ˆéƒ¨åˆ†å¤±è´¥ï¼‰");
    }

    // äº‹ä»¶ç»‘å®š & é¦–æ¬¡åŠ è½½
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action='refresh']");
      if (!btn) return;
      const feedKey = btn.getAttribute("data-feed");
      if (feedKey) loadFeed(feedKey).then(() => {
        document.getElementById("updatedAt").textContent =
          "å·²åˆ·æ–°ï¼š" + new Date().toLocaleString();
      });
    });

    refreshAll();
    // å¦‚éœ€è‡ªåŠ¨è½®è¯¢ï¼Œå¯æ‰“å¼€ä¸‹æ–¹æ³¨é‡Šï¼ˆæ¯ 15 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼‰
    // setInterval(refreshAll, 15 * 60 * 1000);
  </script>
</body>
</html>
